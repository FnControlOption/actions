name: Vendor node_modules

on:
  push:
    branches:
      - 'dependabot/**'

jobs:
  vendor-node-modules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          fetch-depth: 0
          token: ${{ secrets.HOMEBREW_GITHUB_PUBLIC_REPO_TOKEN }}
      - name: Set up Node
        uses: actions/setup-node@v2
        with:
          node-version: '12'
      - name: Configure Git user
        uses: ./git-user-config/
        with:
          username: BrewTestBot
      - name: Set up commit signing
        uses: ./setup-commit-signing/
        with:
          signing_key: ${{ secrets.BREWTESTBOT_GPG_SIGNING_SUBKEY }}
      - name: Vendor node_modules
        run: npm install
      - name: Commit and push changes
        env:
          HOMEBREW_GPG_PASSPHRASE: ${{ secrets.BREWTESTBOT_GPG_SIGNING_SUBKEY_PASSPHRASE }}
        run: |
          if ! git diff --stat --exit-code node_modules; then
            git add node_modules
            git commit -m "node_modules: update"
            git push
          fi
